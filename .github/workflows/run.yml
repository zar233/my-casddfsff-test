name: CF-IP-Base64-Collector
on:
  schedule:
    - cron: '0 20 * * *' # 每天凌晨4点运行
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Collect and Base64
        run: |
          # 1. 抓取你提供的 4 个精品源
          touch temp_ips.txt
          curl -sL "https://cf.001315.xyz/CloudFlareYes" >> temp_ips.txt || true
          curl -sL "https://cf.001315.xyz/ip.164746.xyz" >> temp_ips.txt || true
          curl -sL "https://cf.001315.xyz/CM/ct" >> temp_ips.txt || true
          curl -sL "https://cf.001315.xyz/CM/cmcc" >> temp_ips.txt || true
          
          # 2. 提取 IP 并去重
          grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" temp_ips.txt | sort -u > unique_ips.txt
          
          # 3. 构造原始格式 (IP:443#名称)
          # 注意：这里我们给每个节点加个编号，确保它们在手机里是独立的
          awk '{print $1":443#CM-Node-"NR}' unique_ips.txt > raw_list.txt
          
          # 4. 【关键步骤】转换为 Base64 编码
          # 使用 base64 命令处理，-w 0 表示输出不换行，这是订阅的标准格式
          base64 -w 0 raw_list.txt > ip.txt
          
          echo "处理完成，原始 IP 数量：$(wc -l < raw_list.txt)"

      - name: Commit and Push
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add ip.txt
          git commit -m "Update Base64 IPs" || exit 0
          git push
